<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auction Item</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        background: #f5f6fb;
        color: #111827;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
      }

      header {
        background: #111827;
        color: #fff;
        padding: 24px;
      }

      header a {
        color: #fff;
        text-decoration: none;
        font-weight: 600;
      }

      main {
        max-width: 1100px;
        margin: 0 auto 40px;
        padding: 24px;
        display: grid;
        gap: 24px;
      }

      .card {
        background: #fff;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 15px 35px rgba(15, 23, 42, 0.08);
      }

      h1 {
        margin-top: 0;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 999px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .status-open {
        background: #dcfce7;
        color: #166534;
      }

      .status-sold {
        background: #fee2e2;
        color: #991b1b;
      }

      .status-closed {
        background: #e0e7ff;
        color: #3730a3;
      }

      .meta {
        display: grid;
        gap: 8px;
        color: #4b5563;
        font-size: 0.95rem;
      }

      .grid {
        display: grid;
        gap: 16px;
      }

      .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .gallery img {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-radius: 12px;
        background: #f3f4f6;
      }

      form {
        display: grid;
        gap: 12px;
      }

      .helper {
        margin: 4px 0 0;
        color: #6b7280;
        font-size: 0.85rem;
      }

      label {
        font-weight: 600;
        font-size: 0.9rem;
      }

      input,
      textarea {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        font-size: 1rem;
      }

      button {
        padding: 12px 16px;
        border-radius: 10px;
        border: none;
        background: #2563eb;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      button:disabled {
        background: #93c5fd;
        cursor: not-allowed;
      }

      .notice {
        padding: 16px;
        border-radius: 12px;
        font-weight: 600;
      }

      .notice.success {
        background: #dcfce7;
        color: #166534;
      }

      .notice.error {
        background: #fee2e2;
        color: #991b1b;
      }

      .notice.info {
        background: #e0e7ff;
        color: #3730a3;
      }

      .bids-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 8px;
      }

      .bids-list li {
        padding: 10px 12px;
        border-radius: 10px;
        background: #f8fafc;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        font-size: 0.95rem;
      }

      .bids-list span {
        color: #4b5563;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <header>
      <a href="index.html">← Back to items</a>
    </header>

    <main>
      <section class="card">
        <div id="status"></div>
        <h1 id="title">Loading...</h1>
        <p id="description"></p>
        <div class="meta" id="meta"></div>
      </section>

      <section class="card">
        <h2>Photos</h2>
        <div id="gallery" class="gallery"></div>
        <p id="gallery-empty" class="meta">No photos uploaded yet.</p>
      </section>

      <section class="card" id="bid-section">
        <h2>Place a bid</h2>
        <form id="bid-form">
          <div class="grid">
            <label for="name">Name (initials ok) *</label>
            <input id="name" name="name" required />
          </div>
          <div class="grid">
            <label for="bid">Bid amount *</label>
            <input id="bid" name="bid" type="number" min="1" step="1" required />
            <p class="helper" id="bid-helper">Enter at least the minimum increment.</p>
          </div>
          <div class="grid">
            <label for="phone">Phone or Kakao ID *</label>
            <input id="phone" name="phone" required />
            <p class="helper">We will contact the winning bidder here.</p>
          </div>
          <div class="grid">
            <label for="note">Note (optional)</label>
            <textarea id="note" name="note" rows="3"></textarea>
          </div>
          <button type="submit">Submit bid</button>
        </form>
        <div id="bid-message"></div>
      </section>

      <section class="card" id="closed-section" hidden></section>

      <section class="card" id="bids-section">
        <h2>Recent bids</h2>
        <ul id="bids-list" class="bids-list"></ul>
        <p id="bids-empty" class="meta">No bids yet.</p>
      </section>
    </main>

    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbx7neSPdg_dJlI63QNApAaldHdsugbG4kNm2rHFWML8VqfVB2iXzl5GOCRxqHZumq4x/exec";
      const API_KEY = "auction-2026-ferio-9xQp2";
      const POLL_MS = 3000;

      const params = new URLSearchParams(window.location.search);
      const itemId = params.get("item_id");

      const statusEl = document.getElementById("status");
      const titleEl = document.getElementById("title");
      const descriptionEl = document.getElementById("description");
      const metaEl = document.getElementById("meta");
      const bidSection = document.getElementById("bid-section");
      const closedSection = document.getElementById("closed-section");
      const gallery = document.getElementById("gallery");
      const galleryEmpty = document.getElementById("gallery-empty");
      const bidForm = document.getElementById("bid-form");
      const bidMessage = document.getElementById("bid-message");
      const bidInput = document.getElementById("bid");
      const bidHelper = document.getElementById("bid-helper");
      const bidsList = document.getElementById("bids-list");
      const bidsEmpty = document.getElementById("bids-empty");

      const formatMoney = (value) => {
        const amount = Number(value || 0);
        return amount.toLocaleString(undefined, {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 0,
        });
      };

      const formatDate = (value) => {
        if (!value) return "—";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toLocaleString();
      };

      const buildStatus = (item) => {
        const highestBid = Number(item.highest_bid || 0);
        if (item.status === "CLOSED") {
          return highestBid > 0
            ? { label: "SOLD", className: "status-sold" }
            : { label: "CLOSED", className: "status-closed" };
        }
        return { label: "OPEN", className: "status-open" };
      };

      const renderGallery = () => {
        gallery.innerHTML = "";
        let loaded = 0;
        for (let i = 1; i <= 6; i += 1) {
          const img = document.createElement("img");
          img.src = `assets/${itemId}/${i}.jpg`;
          img.alt = `Photo ${i}`;
          img.onload = () => {
            loaded += 1;
            galleryEmpty.hidden = loaded > 0;
          };
          img.onerror = () => {
            img.remove();
          };
          gallery.appendChild(img);
        }
      };

      const renderBids = (bids = []) => {
        bidsList.innerHTML = "";
        const validBids = Array.isArray(bids) ? bids.filter(Boolean) : [];
        if (validBids.length === 0) {
          bidsEmpty.hidden = false;
          return;
        }
        bidsEmpty.hidden = true;
        validBids.forEach((bid) => {
          const amount = formatMoney(bid.amount || bid.bid || bid.value);
          const name = bid.name || bid.bidder || "Anonymous";
          const time = formatDate(bid.time || bid.timestamp || bid.created_at || bid.time_iso);
          const item = document.createElement("li");
          item.innerHTML = `
            <div><strong>${amount}</strong> by ${name}</div>
            <span>${time}</span>
          `;
          bidsList.appendChild(item);
        });
      };

      const updateBidConstraints = (item) => {
        const minIncrement = Number(item.min_increment || 1);
        const highestBid = Number(item.highest_bid || 0);
        const requiredMin = highestBid + minIncrement;
        bidInput.step = Number.isFinite(minIncrement) && minIncrement > 0 ? minIncrement : 1;
        bidInput.min = Number.isFinite(requiredMin) && requiredMin > 0 ? requiredMin : 1;
        if (bidHelper) {
          bidHelper.textContent = `Minimum bid: ${formatMoney(requiredMin)} (increments of ${formatMoney(
            minIncrement
          )}).`;
        }
      };

      const renderState = (item) => {
        if (!item) return;
        document.title = `${item.title || "Auction Item"} | Auction`;
        const status = buildStatus(item);
        statusEl.innerHTML = `<span class="status-pill ${status.className}">${status.label}</span>`;
        titleEl.textContent = item.title || "Untitled item";
        descriptionEl.textContent = item.description || "";
        const bids = Array.isArray(item.bids) ? item.bids.filter(Boolean) : [];
        const hasBids = bids.length > 0 && Number(item.highest_bid || 0) > 0;
        metaEl.innerHTML = `
          <div><strong>Ends:</strong> ${formatDate(item.end_time_iso)}</div>
          <div><strong>Minimum increment:</strong> ${formatMoney(item.min_increment)}</div>
          <div><strong>Highest bid:</strong> ${formatMoney(hasBids ? item.highest_bid : 0)}</div>
          <div><strong>Highest bidder:</strong> ${hasBids ? item.highest_name || "—" : "—"}</div>
          <div><strong>Last update:</strong> ${formatDate(item.last_update_iso)}</div>
        `;
        updateBidConstraints(item);
        renderBids(bids);

        if (item.status === "OPEN") {
          bidSection.hidden = false;
          closedSection.hidden = true;
        } else {
          bidSection.hidden = true;
          closedSection.hidden = false;
          const highestBid = Number(item.highest_bid || 0);
          if (highestBid > 0) {
            closedSection.innerHTML = `
              <div class="notice success">SOLD</div>
              <p><strong>Winning bid:</strong> ${formatMoney(item.highest_bid)}</p>
              <p><strong>Winner:</strong> ${item.highest_name || "—"}</p>
            `;
          } else {
            closedSection.innerHTML = `
              <div class="notice info">CLOSED (No sale)</div>
              <p>This auction ended without a winning bid.</p>
            `;
          }
        }
      };

      const showError = (message) => {
        statusEl.innerHTML = '<span class="status-pill status-closed">UNAVAILABLE</span>';
        titleEl.textContent = "Unable to load item";
        descriptionEl.textContent = message;
        metaEl.innerHTML = "";
        bidSection.hidden = true;
        closedSection.hidden = false;
        closedSection.innerHTML = `<div class="notice error">${message}</div>`;
      };

      const fetchState = async () => {
        if (!itemId) {
          showError("Missing item id in the URL.");
          return;
        }
        try {
          const response = await fetch(
            `${API_URL}?action=get_state&key=${encodeURIComponent(
              API_KEY
            )}&item_id=${encodeURIComponent(itemId)}`
          );
          const data = await response.json();
          if (!data.ok) {
            showError(`Unable to load item (${data.error || "unknown_error"}).`);
            return;
          }
          renderState(data.item || data);
        } catch (error) {
          console.error("Failed to load item", error);
          showError("Unable to load item. Check the API URL, key, and deployment access.");
        }
      };

      bidForm?.addEventListener("submit", async (event) => {
        event.preventDefault();
        bidMessage.innerHTML = "";

        const payload = {
          action: "place_bid",
          key: API_KEY,
          item_id: itemId,
          name: bidForm.name.value.trim(),
          bid: Number(bidForm.bid.value),
          phone: bidForm.phone.value.trim(),
          note: bidForm.note.value.trim(),
        };

        bidForm.querySelector("button").disabled = true;

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "text/plain;charset=utf-8",
            },
            body: JSON.stringify(payload),
          });
          const data = await response.json();

          if (data.ok) {
            bidMessage.innerHTML = '<div class="notice success">Bid accepted</div>';
            bidForm.reset();
          } else if (data.error === "bid_too_low") {
            bidMessage.innerHTML = `
              <div class="notice error">Bid too low. Minimum required: ${formatMoney(
                data.required_min
              )}</div>
            `;
          } else if (
            data.error === "auction_closed" ||
            data.error === "auction_closed_by_time"
          ) {
            bidMessage.innerHTML =
              '<div class="notice error">Auction closed / sold</div>';
          } else {
            bidMessage.innerHTML =
              '<div class="notice error">Unable to place bid. Please try again.</div>';
          }
        } catch (error) {
          bidMessage.innerHTML =
            '<div class="notice error">Network error. Please try again.</div>';
        } finally {
          bidForm.querySelector("button").disabled = false;
        }
      });

      if (!itemId) {
        titleEl.textContent = "Item not found";
        descriptionEl.textContent = "Missing item_id in the URL.";
        bidSection.hidden = true;
        closedSection.hidden = true;
      } else {
        renderGallery();
        fetchState();
        setInterval(fetchState, POLL_MS);
      }
    </script>
  </body>
</html>
