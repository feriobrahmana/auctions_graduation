<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auction Item</title>
    <script src="assets/network-bg.js" defer></script>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Courier New", Courier, monospace;
        background: #0a0a0a;
        color: #e0e0e0;

        --primary: #FFA500;
        --secondary: #ffffff;
        --glass-bg: rgba(20, 20, 20, 0.7);
        --glass-border: rgba(255, 255, 255, 0.1);
        --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        --input-bg: rgba(0, 0, 0, 0.5);
        --input-border: #444;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
      }

      header {
        background: rgba(10, 10, 10, 0.9);
        backdrop-filter: blur(5px);
        color: #fff;
        padding: 24px;
        border-bottom: 1px dashed var(--primary);
        position: relative;
        z-index: 10;
      }

      header a {
        color: var(--primary);
        text-decoration: none;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      header a:hover {
        color: #fff;
      }

      main {
        max-width: 1100px;
        margin: 0 auto 40px;
        padding: 24px;
        display: grid;
        gap: 30px;
        position: relative;
        z-index: 1;
      }

      .card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        backdrop-filter: blur(10px);
        /* Hexagon look via clip-path for consistency?
           For detail view with lots of text/forms, a full hexagon is hard to use.
           We will use "cut corners" or a tech-panel look instead. */
        clip-path: polygon(
            20px 0, 100% 0,
            100% calc(100% - 20px), calc(100% - 20px) 100%,
            0 100%, 0 20px
        );
        padding: 32px;
        box-shadow: var(--card-shadow);
        border-left: 2px solid var(--primary); /* Accent line */
      }

      h1 {
        margin-top: 0;
        color: #fff;
        font-size: 1.8rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        border-bottom: 1px solid #333;
        padding-bottom: 16px;
      }

      h2 {
        color: var(--primary);
        font-size: 1.2rem;
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        padding: 4px 10px;
        border: 1px solid currentColor;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 16px;
      }

      .status-open {
        color: var(--primary);
      }

      .status-sold {
        color: #ff4444;
      }

      .status-closed {
        color: #888;
      }

      .meta {
        display: grid;
        gap: 12px;
        color: #aaa;
        font-size: 0.9rem;
        border-top: 1px dashed #333;
        padding-top: 16px;
        margin-top: 16px;
      }

      .meta div strong {
        color: #fff;
        margin-right: 8px;
        text-transform: uppercase;
        font-size: 0.8rem;
      }

      .grid {
        display: grid;
        gap: 16px;
      }

      .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .gallery img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #222;
        border: 1px solid #444;
        filter: grayscale(100%);
        transition: filter 0.2s, transform 0.2s;
        /* Hexagon mask for gallery images too */
        clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
      }

      .gallery img:hover {
        filter: grayscale(0%);
        transform: scale(1.02);
        z-index: 2;
      }

      form {
        display: grid;
        gap: 20px;
      }

      .helper {
        margin: 6px 0 0;
        color: #666;
        font-size: 0.75rem;
      }

      label {
        font-weight: bold;
        font-size: 0.8rem;
        color: var(--primary);
        margin-bottom: 6px;
        display: block;
        text-transform: uppercase;
      }

      input,
      textarea {
        width: 100%;
        padding: 12px 14px;
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        color: #fff;
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 0.2s;
        border-radius: 0; /* Sharp corners */
      }

      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(255, 165, 0, 0.1);
      }

      button {
        padding: 14px 20px;
        border: 1px solid var(--primary);
        background: transparent;
        color: var(--primary);
        font-weight: bold;
        cursor: pointer;
        font-family: inherit;
        text-transform: uppercase;
        letter-spacing: 2px;
        transition: all 0.2s;
        clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
      }

      button:hover {
        background: var(--primary);
        color: #000;
      }

      button:disabled {
        border-color: #555;
        color: #555;
        cursor: not-allowed;
      }

      button:disabled:hover {
        background: transparent;
      }

      .notice {
        padding: 16px;
        font-weight: bold;
        text-align: center;
        border: 1px solid;
        text-transform: uppercase;
      }

      .notice.success {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(255, 165, 0, 0.1);
      }

      .notice.error {
        border-color: #ff4444;
        color: #ff4444;
        background: rgba(255, 68, 68, 0.1);
      }

      .notice.info {
        border-color: #fff;
        color: #fff;
        background: rgba(255, 255, 255, 0.05);
      }

      .bids-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 1px; /* Divider look */
        background: #333;
        border: 1px solid #333;
      }

      .bids-list li {
        padding: 12px 16px;
        background: #111;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        font-size: 0.9rem;
      }

      .bids-list span {
        color: #666;
        font-size: 0.75rem;
      }
    </style>
  </head>
  <body>
    <header>
      <a href="index.html">&lt; RETURN_TO_GRID</a>
    </header>

    <main>
      <section class="card">
        <div id="status"></div>
        <h1 id="title">INITIALIZING...</h1>
        <p id="description"></p>
        <div class="meta" id="meta"></div>
      </section>

      <section class="card">
        <h2>VISUAL_DATA</h2>
        <div id="gallery" class="gallery"></div>
        <p id="gallery-empty" class="meta" style="border-top: none;">NO_DATA_AVAILABLE</p>
      </section>

      <section class="card" id="bid-section">
        <h2>INPUT_BID</h2>
        <form id="bid-form">
          <div class="grid">
            <label for="name">IDENTITY (INITIALS) *</label>
            <input id="name" name="name" required />
          </div>
          <div class="grid">
            <label for="bid">VALUE (USD) *</label>
            <input id="bid" name="bid" type="number" min="1" step="1" required />
            <p class="helper" id="bid-helper">MIN_INCREMENT_REQUIRED</p>
          </div>
          <div class="grid">
            <label for="phone">CONTACT_PROTOCOL (PHONE/KAKAO) *</label>
            <input id="phone" name="phone" required />
            <p class="helper">WINNING_BIDDER_WILL_BE_CONTACTED</p>
          </div>
          <div class="grid">
            <label for="note">ANNOTATION (OPTIONAL)</label>
            <textarea id="note" name="note" rows="3"></textarea>
          </div>
          <button type="submit">TRANSMIT_BID</button>
        </form>
        <div id="bid-message"></div>
      </section>

      <section class="card" id="closed-section" hidden></section>

      <section class="card" id="bids-section">
        <h2>TRANSACTION_LOG</h2>
        <ul id="bids-list" class="bids-list"></ul>
        <p id="bids-empty" class="meta" style="border-top: none;">NO_RECORDS</p>
      </section>
    </main>

    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbwwOQRLOHxZslp-fScI-HyGnqWuwjQd_BuVFTU7MSkEqvdtSfCpmtxc1PbuBTJ9odFu/exec";
      const API_KEY = "auction-2026-ferio-9xQp2";
      const POLL_MS = 3000;

      const params = new URLSearchParams(window.location.search);
      const itemId = params.get("item_id");

      const statusEl = document.getElementById("status");
      const titleEl = document.getElementById("title");
      const descriptionEl = document.getElementById("description");
      const metaEl = document.getElementById("meta");
      const bidSection = document.getElementById("bid-section");
      const closedSection = document.getElementById("closed-section");
      const gallery = document.getElementById("gallery");
      const galleryEmpty = document.getElementById("gallery-empty");
      const bidForm = document.getElementById("bid-form");
      const bidMessage = document.getElementById("bid-message");
      const bidInput = document.getElementById("bid");
      const bidHelper = document.getElementById("bid-helper");
      const bidsList = document.getElementById("bids-list");
      const bidsEmpty = document.getElementById("bids-empty");

      const formatMoney = (value) => {
        const amount = Number(value || 0);
        return amount.toLocaleString(undefined, {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 0,
        });
      };

      const formatDate = (value) => {
        if (!value) return "—";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toLocaleString();
      };

      const buildStatus = (item) => {
        const highestBid = Number(item.highest_bid || 0);
        if (item.status === "CLOSED") {
          return highestBid > 0
            ? { label: "SOLD", className: "status-sold" }
            : { label: "CLOSED", className: "status-closed" };
        }
        return { label: "OPEN", className: "status-open" };
      };

      const renderGallery = () => {
        gallery.innerHTML = "";
        let loaded = 0;
        for (let i = 1; i <= 6; i += 1) {
          const img = document.createElement("img");
          img.src = `assets/${itemId}/${i}.jpg`;
          img.alt = `Photo ${i}`;
          img.onload = () => {
            loaded += 1;
            galleryEmpty.hidden = loaded > 0;
          };
          img.onerror = () => {
            img.remove();
          };
          gallery.appendChild(img);
        }
      };

      const renderBids = (bids = []) => {
        bidsList.innerHTML = "";
        const validBids = Array.isArray(bids) ? bids.filter(Boolean) : [];
        if (validBids.length === 0) {
          bidsEmpty.hidden = false;
          return;
        }
        bidsEmpty.hidden = true;
        validBids.forEach((bid) => {
          const amount = formatMoney(bid.amount || bid.bid || bid.value);
          const name = bid.name || bid.bidder || "ANONYMOUS";
          const time = formatDate(bid.time || bid.timestamp || bid.created_at || bid.time_iso);
          const item = document.createElement("li");
          item.innerHTML = `
            <div><strong>${amount}</strong> BY ${name}</div>
            <span>${time}</span>
          `;
          bidsList.appendChild(item);
        });
      };

      const updateBidConstraints = (item) => {
        const minIncrement = Number(item.min_increment || 1);
        const highestBid = Number(item.highest_bid || 0);
        const requiredMin = highestBid + minIncrement;
        bidInput.step = Number.isFinite(minIncrement) && minIncrement > 0 ? minIncrement : 1;
        bidInput.min = Number.isFinite(requiredMin) && requiredMin > 0 ? requiredMin : 1;
        if (bidHelper) {
          bidHelper.textContent = `MIN_BID: ${formatMoney(requiredMin)} (INCREMENT: ${formatMoney(
            minIncrement
          )}).`;
        }
      };

      const renderState = (item) => {
        if (!item) return;
        document.title = `${item.title || "ITEM"} | AUCTION_NET`;
        const status = buildStatus(item);
        statusEl.innerHTML = `<span class="status-pill ${status.className}">${status.label}</span>`;
        titleEl.textContent = item.title || "UNTITLED_ITEM";
        descriptionEl.textContent = item.description || "";
        const bids = Array.isArray(item.bids) ? item.bids.filter(Boolean) : [];
        const hasBids = Number(item.highest_bid || 0) > 0;
        metaEl.innerHTML = `
          <div><strong>DEADLINE:</strong> ${formatDate(item.end_time_iso)}</div>
          <div><strong>INCREMENT:</strong> ${formatMoney(item.min_increment)}</div>
          <div><strong>CURRENT_HIGH:</strong> ${formatMoney(hasBids ? item.highest_bid : 0)}</div>
          <div><strong>HOLDER:</strong> ${hasBids ? item.highest_name || "—" : "—"}</div>
          <div><strong>LAST_SYNC:</strong> ${hasBids ? formatDate(item.last_update_iso) : "—"}</div>
        `;
        updateBidConstraints(item);
        renderBids(item.bids);

        if (item.status === "OPEN") {
          bidSection.hidden = false;
          closedSection.hidden = true;
        } else {
          bidSection.hidden = true;
          closedSection.hidden = false;
          const highestBid = Number(item.highest_bid || 0);
          if (highestBid > 0) {
            closedSection.innerHTML = `
              <div class="notice success">ITEM_SOLD</div>
              <p><strong>WINNING_BID:</strong> ${formatMoney(item.highest_bid)}</p>
              <p><strong>WINNER:</strong> ${item.highest_name || "—"}</p>
            `;
          } else {
            closedSection.innerHTML = `
              <div class="notice info">CLOSED_NO_SALE</div>
              <p>AUCTION_TERMINATED_WITHOUT_WINNER.</p>
            `;
          }
        }
      };

      const showError = (message) => {
        statusEl.innerHTML = '<span class="status-pill status-closed">ERROR</span>';
        titleEl.textContent = "LOAD_FAILURE";
        descriptionEl.textContent = message;
        metaEl.innerHTML = "";
        bidSection.hidden = true;
        closedSection.hidden = false;
        closedSection.innerHTML = `<div class="notice error">${message}</div>`;
      };

      const fetchState = async () => {
        if (!itemId) {
          showError("MISSING_ITEM_ID");
          return;
        }
        try {
          const response = await fetch(
            `${API_URL}?action=get_state&key=${encodeURIComponent(
              API_KEY
            )}&item_id=${encodeURIComponent(itemId)}`
          );
          const data = await response.json();
          if (!data.ok) {
            showError(`API_ERROR (${data.error || "UNKNOWN"}).`);
            return;
          }
          renderState(data.item || data);
        } catch (error) {
          console.error("Failed to load item", error);
          showError("NETWORK_FAILURE. CHECK_CONNECTION.");
        }
      };

      bidForm?.addEventListener("submit", async (event) => {
        event.preventDefault();
        bidMessage.innerHTML = "";

        const payload = {
          action: "place_bid",
          key: API_KEY,
          item_id: itemId,
          name: bidForm.name.value.trim(),
          bid: Number(bidForm.bid.value),
          phone: bidForm.phone.value.trim(),
          note: bidForm.note.value.trim(),
        };

        bidForm.querySelector("button").disabled = true;

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "text/plain;charset=utf-8",
            },
            body: JSON.stringify(payload),
          });
          const data = await response.json();

          if (data.ok) {
            bidMessage.innerHTML = '<div class="notice success">BID_ACKNOWLEDGED</div>';
            bidForm.reset();
          } else if (data.error === "bid_too_low") {
            bidMessage.innerHTML = `
              <div class="notice error">REJECTED: BID_TOO_LOW. MIN: ${formatMoney(
                data.required_min
              )}</div>
            `;
          } else if (
            data.error === "auction_closed" ||
            data.error === "auction_closed_by_time"
          ) {
            bidMessage.innerHTML =
              '<div class="notice error">REJECTED: AUCTION_CLOSED</div>';
          } else {
            bidMessage.innerHTML =
              '<div class="notice error">TRANSMISSION_ERROR. RETRY.</div>';
          }
        } catch (error) {
          bidMessage.innerHTML =
            '<div class="notice error">NETWORK_ERROR. RETRY.</div>';
        } finally {
          bidForm.querySelector("button").disabled = false;
        }
      });

      if (!itemId) {
        titleEl.textContent = "NOT_FOUND";
        descriptionEl.textContent = "URL_PARAMETER_MISSING: item_id";
        bidSection.hidden = true;
        closedSection.hidden = true;
      } else {
        renderGallery();
        fetchState();
        setInterval(fetchState, POLL_MS);
      }
    </script>
  </body>
</html>
